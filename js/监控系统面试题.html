<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <pre>
    前端监控系统的难点和重点？
      前端监控系统主要是用来收集用户的行为，报错信息，性能指标，确保系统在生产环境的稳定性；
      对于错误信息，可以提前发现并进行及时的处理；也可提供大量的用户的行为数据，结合ai模型
      进行分析，提供公司业务对未来的决策和发展趋势；

      1. 如何准确的，高效的收集和上报数据？
        通过beacon API在离开当前页面的时候上报数据，保证数据不会丢失，并且对用户的影响最小化，
        而且可以实现批量上报；

      2. 对于用户的隐私进行过滤处理，不上报用户的个人信息

      3. 如何精确的测量和分析性能指标？
        通过performance API可以检测页面的加载情况，分析出LCP,CLS,FID等指标，结合数据对性能进行
        针对性优化处理；而且也可以分析出不同设备不同浏览器的性能问题，再进行分类归纳；

      4. 如何捕获到代码中的错误信息，特别是不同设备或浏览器表现不一致的情况？
        可以通过window.onerror或者window.addEventListener('error')来监听js错误，通过监听
        unhandledrejection来监听promise的错误；
        对于错误信息，需要去重处理，防止上报大量的数据，根据错误信息所在的页面，用户名，错误类型，
        具体的错误信息等生成唯一的hash值，这样可以进行去重处理，只上报该错误类型的数量；

      5. 如何记录和上报用户的行为？
         监听项目中使用到的事件，比如点击事件等，在这些事件中把当前页面的路由，按钮所在的dom元素等
         保存在一个数组中，等到离开页面的时候进行上报

      6. 如何把用户行为串联起来？
          在用户登录或者一打开页面的时候，根据用户信息和当前时间生成一个会话id,并且保存起来，以后每次
          用户的操作和页面的访问，报错信息都携带上这个会话id和当前的时间。这样在服务端根据这个id查询所
          有的数据并且返回给客户端，客户端根据时间搓可以把用户的行为串联起来进行展示；
        
      面试题
        你在项目中如何实现前端性能监控？请描述你使用的指标和工具？
        如何捕获和处理前端错误？如何区分和聚合相同类型的错误？
        请解释什么是First Contentful Paint (FCP)和Largest Contentful Paint (LCP)，它们在性能监控中有什么意义？
        如何在不影响用户体验的情况下收集用户行为数据？你如何处理这些数据的隐私问题？
        如何确保前端监控系统的高可用性和扩展性？
        描述你如何设计一个错误报警系统，使之能区分严重性并适时通知相关人员。
        在前端监控系统中，如何实现数据的可视化？你会选择哪些工具或技术？
        如何在单页应用（SPA）中进行页面性能监控？与传统多页应用有何不同？
        你会如何在前端监控系统中处理跨域数据上报的问题？
        如何处理前端监控数据的采样问题？在什么情况下会选择进行数据采样？

        1. 你在项目中如何实现前端性能监控？请描述你使用的指标和工具？
          通过PerformanceObserver构造器创建的实例下的observe来检测指定的类型的性能，
          比如LCP最大内容绘制，resource静态资源加载，资源的加载地址，类型，时间，dns
          解析时间，连接时间等等；FID可交互时间;也可可在页面加载完成之后通过
          performance.getEntriesByName来检测FP白屏时间，FCP首个内容绘制时间；也可以
          通过performance.getEntriesBtType('navigation')来检测从输入地址到页面展示
          各个阶段的时间；收集完毕之后通过beacon进行统一上报；

        2. 如何捕获和处理前端错误？如何区分和聚合相同类型的错误？
            - 对于js的错误可以通过window.onError来捕获，上报报错的具体信息，报错所在文件以及
            页面路径和报错的行和列；
            - 对于静态资源的错误和跨域错误，可以通过addEvenListener来监听error,通过判断报错的
            event是不是ErrorEvent的实例，如果是就表示js的普通错误，否则就是资源错误；在普通
            错误中再通过报错的信息中是否是script error来判断是否是跨域错误；上报资源文件，行和
            列，错误信息；
            - promise错误：通过监听unhandledrejection来监听promise的错误
            - vue错误：通过全局的Vue.config.errorHandler来捕获vue的错误；
            - http的错误：重写XMLHttpRequest和fetch方法，在状态码为400以上就进行上报，上报请求
              路径，状态码，错误信息，参数；
            在错误上报的时候，如果有开启用户行为上报，那么就把用户行为也进行上报，这样有利于查找
            用户是怎么操作导致报错的；

            - 对于相同文件，相同的错误信息进行统计不会进行重复上报，有个阈值，比如相同的错误统计
            数量达到十次的时候进行一次上报；只上报本错误类型的次数；通过把报错的文件路径，报错的
            信息，报错的行和列生成一个hash值进行保存，每次报错都去查找判断；这样就可以区分错误
            类型和聚合错误；

        3. 请解释什么是First Contentful Paint (FCP)和Largest Contentful Paint (LCP)，它们在性能监控中有什么意义？
            - FCP：页面中首个可见内容显示的时间，FCP标志这从打开连接到用户看到首个内容的时间，也就是白屏时间，影响用户的感知，
                  可以分析出影响FCP的一些因素，从而进行针对优化，比如资源的加载时间，资源的请求时间，DNS的解析时间，tcp的连接时间；
                  缩短这些时间有助于减少白屏的时间；它应该控制在1s之内；
            - LCP: 页面中最大可见内容完全显示的时间，可能是图片，文本等，它也是性能的核心指标，LCP时间越短用户感知页面加载的速度越快
                  一般控制在2.5s之内；对于LCP可以针对关键资源进行优化，比如图片的压缩，格式的选择等

            - FCP和LCP都可以通过谷歌浏览器提供的插件进行测量，分析和优化，比如lighthouse等

        4. 如何在不影响用户体验的情况下收集用户行为数据？你如何处理这些数据的隐私问题？
            - 使用无感知收集，嵌入的SDK尽量小，并且通过异步加载和执行，避免和其他资源的竞争，通过批量在页面关闭之前进行上报；
            - 隐私问题，可以提前展示隐私协议告知用户要收集的用户信息，存储的地方和存储时间等；也可以在收集的时候剔除掉用户的
              个人信息，比如在使用sdk的时候传入用户的一些个人信息的key，上传的时候过滤掉这些key;并且在上传的时候需要通过加密进行传输；
            
        5. 如何确保前端监控系统的高可用性和扩展性？
            - 通过插件的形式，暴露给开发者一个方法，开发者调用这个方法传递所开发的插件就可以进行扩展功能了；

        6. 描述你如何设计一个错误报警系统，使之能区分严重性并适时通知相关人员。
          - 首先前端要把错误进行分类上传，比如js报错，资源加载报错，还是接口请求报错
          - 后端结合核心业务或一定时间之内相同错误的报错频率来区分是严重错误，还是中等错误，阻断流程的或者关键资源加载失败导致页面打不开
            或者核心页面存在js报错的，或者报错影响的范围比较大的都是严重错误，需要给指定的人比如项目的核心开发人员，项目经理发送短信进行
            通知；对于影响交小的比如只有某款手机上的某个浏览器才会报的错误就是一般错误，可发邮件通知开发人员；
          - 后续可以记录错误以及解决方案，组员进行分享，提高组员应对错误的能力

        7. 在前端监控系统中，如何实现数据的可视化？你会选择哪些工具或技术？
          - 数据的可视化能够直观的展示系统的性能，错误信息等数据，实时的数据可以帮助技术人员进行分析，查看数据，识别发现问题；
          - 对于可视化数据前端采用了echarts图表工具，今日的报错类型和数量，一周的报错类型和数量是饼状图，本月每个类型的报错数量折线图
            严重错误报警，类型和数量和用户占比；应用对应的性能折线图，用户分布地图，页面访问量折线图等；通过轮询的方式五秒刷一次数据；

        8. 如何在单页应用（SPA）中进行页面性能监控？与传统多页应用有何不同？
          - 单页面中的性能检测主要检测应用首次加载的时间，LCP,FCP,TBT,DNS,TCP，FID,CLS等的连接时间；单页面应用中页面的跳转都是通过路由修改地址，
            通过js动态的创建展示对应的页面内容；而多页面应用每次跳转都会从服务端获取页面信息，因为多页面应用需要给每个页面进行设置监控；
            监控每个页面的性能；

        9. 如何处理前端监控数据的采样问题？在什么情况下会选择进行数据采样？
          - 数据采样主要是为了高流量和大数据量给服务端带来的性能和成本的开销
          - 当用户量庞大并且用户行为相似的用户行为埋点，可以采集有代表性的数据，不必全部采集存储，只进行统计数量；
          - 根据用户所在的地区，用户数量按照比例进行采集；
          - 根据时间进行采集，比如每次上线之后的前几天全量采集，慢慢采集50%，30%等；
          - 根据流量进行采集，比如高峰期采集比例降低，低峰期采集比例升高；
          - 采集后根据采集的比例对数据进行估算，分析；
          
  </pre>
  <script>
  </script>
</body>
</html>